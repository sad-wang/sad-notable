---
tags: [HappyWriting]
title: 小程序端业务逻辑功能
created: '2020-05-25T06:16:13.210Z'
modified: '2020-06-02T01:42:57.435Z'
---

# 小程序端业务逻辑功能

### APP 全局
#### 判断云开发可用状态
若不可用，提示？
#### 获取用户 openid
* 获取用户的 openid，用于判断用户是否存在；
* 通过调用云函数，在回调中得到用户 openid；
#### 判断用户是否存在
* 查询用户表 _openid 字段值为用户 openid 的用户是否存在；
* 不存在则初始化用户；
* 保存用户信息到全局；
#### 初始化用户
* 初始化用户信息；
```JavaScript
{
  _id: [自动生成],
  _openid: [用户openid],
  info: {},
  nickname: null,
  tel: null,
  course: {},
  create_date: [创建时间]
}
```
* 保存用户信息到全局；

### 主页页面
#### 获取作业广场数据
* 查询作业表所有数据；
#### 获取推荐课程轮播数据
* 查询课程表 recommend 字段值为 true 的数据，得到字段为 _id、course_image 的对象数组；
#### 跳转课程海报页面
* 传递对应的课程的id；
#### 跳转作业页面
* 传递对应的作业id；
#### 上拉页面获取新数据
* **_二期_**
#### 渲染主页
* 轮播数据渲染轮播；
* 作业广场数据渲染作业广场 ；

### 课程海报页面

#### 获取传递的数据
* 获取传递的课程id
#### 查询课程数据
* 查询课程表中id字段为id的课程；
* 查询用户表中openid为全局openid的用户，获取用户course键为id的数据；
#### 初始化报名表单组件
* 包括组件函数功能函数和内容
#### 初始化报名表单提示组件
* 包括组件函数功能函数和内容
#### 获取验证码
* 调用接口发送请求；
#### 获取用户手机号
* 判断全局用户信息中tel是否为空；
* 空则获取手机号权限，且在数据库中存下；
* 非空则得到用户手机号；
#### 实现手机号输入框双向绑定和判断合法性
* 双向绑定;
* 正则判断;
#### 实现验证码按钮时间限制
* 获取验证码后设置定时器；
* 是否可用由手机号合法与定时器状态决定；
#### 报名课程以及用户课程初始化数据
* 验证码通过则插入课程id到用户信息course中
```JavaScript
      [COURSE_ID]: {
      course_schedule: [Number] // 课程进度，初始化为 0
      create_date: [DATE] // 课程创建日期
      course_section: // 子课程对象数组,子课程数目决定数组长度
        [
          {
            homework_id: [String ||| null] // 作业 ID，初始化为 null
            video_schedule: [Array] // 视频进度数组，初始化全为 false
          },
          ...
        ]
```
#### 渲染课程海报页面
* 渲染课程数据海报；
* 渲染表单组件和提示组件；


### 课程页面
#### 获取课程数据
* 查询课程表所有数据；
#### 获取用户课程数据
* 获取用户表的课程数据；
* 查询用户表字段为 openid 值为全局存储的 _openid 的数据，得到唯一的查询结果的course数据；
#### 重构页面课程数据
* 把课程数据分为已报名未完结课程数据和未报名课程数据以及已完结课程；
* 通过用户course数据的键名判断是否报名；
* 通过用户course数据的create_date与当前日期以及课程数据的日期判断是否已完结；
* 把已报名的课程添加用户对应的course数据对象的create_date键值对，把已报名的课程的course_sectiont数组的所有对象添用户对应的course数据对象的course_section的对应的所有键值对；
#### 跳转课程详情页面
* 传递对应课程数据；
#### 跳转课程海报页面
* 传递对应的课程的id；
#### 渲染课程页面
* 已报名未完结课程数据渲染已报名课程列表；
* 未报名课程数据渲染未报名数据；
* 通过判断课程create_date和课程courese_duration，得到课程日期；
* 通过判断课程course_section的length和course_schedule,得到课程待完成数据；

### 已完结课程页面


### 课程详情页面
#### 获取传递的数据
* 获取课程数据；
#### 跳转课程学习页面
* 传递课程数据；
* 传递课程小节索引；
#### 讲师数据的修改
* 查询讲师表字段_id为数据中讲师id的数据，并以对象数组的形式重构讲师数据；
```JavaScript
[
  {
    _id: [String], // 讲师id
    avatar： [String], // 讲师头像URL
    name: [String] // 讲师名字
  }
]
```
#### 渲染课程详情页面
* 渲染课程数据；
* 通过判断课程create_date和课程courese_duration，得到课程日期；
* 通过判断课程course_section对应子课程的video_schedule和video.length，得到作业学习完成状态；
* 通过判断课程course_section的homework_id是否为null，得到作业提交状态；


### 课程学习页面
#### 获取传递的数据
* 获取课程数据；
* 获取课程小节索引；
#### 跳转作业页面
* 传递homework_id数据；
* 传递课程小节索引；
* 传递课程id
#### 获取作业数据
* 查询作业表字段_id为homework_id的数据；
* 传递课程小节索引；
#### 渲染课程学习页面
* 渲染讲师数据；
* 渲染课程期限数据；
* 根据course_section渲染课程标题、视频列表、作业内容；
* 通过判断课程小节video.lenghth渲染视频个数；
* 通过判断课程小节video的子对象的duration值相加渲染课程时间；
* 通过判断作业数据的值判断渲染按钮状态；
#### 实现视频播放等事件
* 创建一个隐藏的视频；
* 获取对应视频链接，js控制实现全屏播放；
* 视频播放完成，设置对应视频state为true;

### 作业页面 
#### 获取传递的数据
* 获取homework_id；
* 获取课程id；
* 获取课程索引；
#### 查询作业数据
* homework_id不为空则查询作业列表字段_id为作业id的数据；
#### 修改已读状态
* viewed值为true，存储到用户信息中；
#### 上传作业
* 调用微信API上传图片；
* 存入云存储库中；
* 初始化作业实例插入用户表中；
```JavaScript
{
  _id: [String], // 作业id，自动生成
  user_id: [String], // 用户id，从用户信息中获取
  lecturer_id：	[String],	// 讲师 ID，从讲师信息数组中获取，第一个讲师id
  review_audio：[String],	// 初始化为null
  homework_image：[String],	// 初始化为图片云库url
  review_data: [Object],	// 初始化为null
  liked_sum: [Number],	// 初始化为null
  create_date:	[Date], // 根据创建时间生成
  state: [String], // 初始化为submited
  course_id: [String], // 初始化为课程id
  section_index: [Number], // 初始化为课程小节索引
  recommend: [Boolean], // 初始化为false
  viewed: [Boolean], // 初始化为true
}
* 
```
#### 修改作业
* 调用微信API上传图片；
* 存入云存储库中；
#### 点赞
* 作业数据liked_sum++;
* 修改作业列表字段_id为作业id的数据；
#### 点评控件的实现
* **_难点_**
#### 渲染作业页面
* homework_id是为空则按钮为上传作业，无作业图片，无底部栏；
* homework_id不为空且state为submited，按钮为修改作业，显示作业图片，无底部栏；
* homework_id不为空且state为reviewed，不显示按钮，显示作业图片，显示底部栏；

### 我的页面
#### 实现获取用户信息的权限
* 使用微信开发能力按钮，获取用户信息；
* 修改用户表_id为用户id的info值；
#### 判断用户信息是否存在
* 查询用户表_id为用户id的info值是否为{}；
#### 修改用户信息
* **_没有界面_**
#### 跳转我的作品集
* 传递我在作业数据；
#### 渲染我的页面
* 根据用户信息是否存在，渲染开放能力的按钮；
* 根据用户信息渲染用户头像和id；
* 查询我的作业数目、作业recommend为true的数目、作业liked_sum总和渲染个人数据；
* 查询是否存在作业viewed为true的作业，有则渲染有新的批改待查看;

### 我的作品集页面
#### 获取传递数据
* 获取传递数据作业数据
#### 渲染我的作品集页面；
* 根据作业集数据渲染页面；
* 根据viewed为false渲染待查看；
#### 跳转作业页面
* 传递对应的作业id；

